pipeline {
    agent any

    environment {
        // Docker image details
        DOCKER_IMAGE = 'fares29/django_project'  // Update with your Docker Hub username/repo
        DOCKER_TAG = 'latest'
        REGISTRY = 'docker.io'
        GITHUB_REPO = 'https://github.com/fares29-kh/django_project.git'
        GIT_CREDENTIALS = 'github-token'  // The Jenkins credential ID for GitHub access
    }

    stages {
        stage('Checkout') {
            steps {
                // Pull the latest code from your GitHub repository
                git credentialsId: "${GIT_CREDENTIALS}", url: "${GITHUB_REPO}"
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    // Build Docker image using the Dockerfile
                    sh 'docker build -t $REGISTRY/$DOCKER_IMAGE:$DOCKER_TAG .'
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                script {
                    // Login to Docker Hub (you need to configure your credentials in Jenkins)
                    sh 'docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD'

                    // Push the Docker image to the registry (Docker Hub)
                    sh 'docker push $REGISTRY/$DOCKER_IMAGE:$DOCKER_TAG'
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    // Deploy the app using Docker Compose
                    // First, bring down any existing containers
                    sh 'docker-compose down'

                    // Then, bring up the containers again (detached mode)
                    sh 'docker-compose up -d'
                }
            }
        }
    }

    post {
        success {
            // Actions to take if deployment succeeds
            echo 'Deployment successful!'
        }
        failure {
            // Actions to take if deployment fails
            echo 'Deployment failed.'
        }
    }
}
